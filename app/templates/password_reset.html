{# templates/password_reset.html #}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Password reset â€” Kerala Vishwakarma</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --bg1: #f7fbff;
      --bg2: #f0f5fb;
      --card: #ffffff;
      --muted: #6c757d;
      --accent: #0b5ed7;
    }

    html,body { height:100%; }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(circle at 10% 20%, rgba(11,94,215,0.04), transparent 6%),
        linear-gradient(180deg,var(--bg1), var(--bg2) 60%);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      padding: 1.25rem;
    }

    .card-shell{
      width:100%;
      max-width:960px;
      border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
      box-shadow: 0 20px 40px rgba(9,30,66,0.06);
      overflow: hidden;
      display:flex;
      flex-direction:row;
    }

    /* left form area */
    .left {
      flex:1 1 520px;
      padding:2rem;
      background: var(--card);
    }

    /* right info column */
    .right {
      width:360px;
      padding:1.75rem;
      background: linear-gradient(180deg,#fbfdff,#f5f9ff);
      border-left:1px solid rgba(2,6,23,0.03);
    }

    h3 { margin-top:0; margin-bottom:.5rem; font-weight:700; color:#0b3a76; }
    .small-muted{ color:var(--muted); font-size:.95rem; }

    .otp-boxes { display:flex; gap:.5rem; justify-content:center; margin-top:.35rem; }
    .otp-boxes input{
      width:48px;height:56px;text-align:center;font-size:22px;border-radius:10px;border:1px solid #e6eefc;
      background: #fbfdff;
    }

    .btn-ghost { background:transparent;border:1px solid #e7eefc;color:var(--accent);border-radius:10px }
    .btn-primary { border-radius:10px; font-weight:600; padding:.55rem 1rem; }

    .toast-pos{ position:fixed; top:1rem; right:1rem; z-index:1300; }

    @media (max-width: 900px){
      .card-shell{ flex-direction:column; max-width:720px; }
      .right{ width:100%; order:2; }
      .left{ order:1; }
    }

    .muted-note{ font-size:.88rem; color:var(--muted) }
  </style>
</head>
<body>

  <div class="card-shell">
    <div class="left">
      <h3>Reset your password</h3>
      <p class="small-muted">Enter your registered email to receive a 6-digit OTP. After verifying the OTP you can set a new password.</p>
      <hr/>

      <form id="pr_form" novalidate>
        {% csrf_token %}

        <!-- Email -->
        <div id="emailSection" class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" id="pr_email" class="form-control" placeholder="you@domain.com" autocomplete="email" />
          <div class="mt-2 d-flex gap-2">
            <button id="sendOtpBtn" type="button" class="btn btn-primary">Send OTP</button>
            <button id="sendOtpBtnDisabled" class="btn btn-primary" disabled style="display:none">Sending...</button>
            <button id="toLogin" type="button" class="btn btn-ghost ms-auto" onclick="window.location.href='{% url 'login' %}'">Back to Login</button>
          </div>
          <div class="mt-2 small muted-note">If you don't receive the email, check spam or try resending after 90 seconds.</div>
        </div>

        <!-- OTP -->
        <div id="otpSection" style="display:none;">
          <label class="form-label">Enter 6-digit OTP</label>
          <div class="otp-boxes" id="otpBoxes">
            <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" />
            <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" />
            <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" />
            <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" />
            <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" />
            <input type="text" maxlength="1" class="otp-input" inputmode="numeric" pattern="[0-9]*" />
          </div>

          <div class="d-flex align-items-center gap-2 mt-3 mb-1">
            <button id="verifyOtpBtn" type="button" class="btn btn-success">Verify OTP</button>
            <button id="resendOtpBtn" type="button" class="btn btn-secondary" disabled>Resend (1:30)</button>
            <div id="resendTimer" class="small-muted ms-2"></div>
          </div>
        </div>

        <!-- New password -->
        <div id="passwordSection" style="display:none;">
          <label class="form-label">New Password</label>
          <input type="password" id="new_password" class="form-control mb-2" placeholder="Minimum 8 characters" autocomplete="new-password" />
          <label class="form-label">Confirm New Password</label>
          <input type="password" id="confirm_password" class="form-control mb-2" placeholder="Confirm password" autocomplete="new-password" />
          <div class="d-flex justify-content-between mt-2">
            <button id="cancelReset" class="btn btn-ghost" type="button">Cancel</button>
            <button id="submitReset" class="btn btn-primary" type="button">Set New Password</button>
          </div>
        </div>
      </form>

    </div>

    <div class="right">
      <h5>How it works</h5>
      <ol class="small-muted">
        <li>Send OTP to the registered email.</li>
        <li>Enter the 6-digit code you received by email.</li>
        <li>After verification, choose a new password.</li>
      </ol>

      <hr/>
      <p class="small-muted">OTP expires in 5 minutes. Resend allowed every 90 seconds. OTP and attempt limits protect your account.</p>

      <div style="margin-top:1rem">
        <strong>Need help?</strong>
        <p class="small-muted">Contact your shakha president or <a href="mailto:support@example.com">support</a>.</p>
      </div>
    </div>
  </div>

  <div class="toast-pos" id="toastHolder"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  /* Helper: show toast */
  function showToast(msg, type='danger', ttl=3500){
    const container = document.getElementById('toastHolder');
    const el = document.createElement('div');
    el.className = `toast text-bg-${type} border-0 mb-2`;
    el.setAttribute('role','alert'); el.setAttribute('aria-live','assertive'); el.setAttribute('aria-atomic','true');
    el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
    container.appendChild(el);
    const bsToast = new bootstrap.Toast(el, { delay: ttl });
    bsToast.show();
    el.addEventListener('hidden.bs.toast', () => el.remove());
  }

  /* Utility: get CSRF token (from form rendered by Django) */
  function getCSRF(){
    const el = document.querySelector('input[name=csrfmiddlewaretoken]');
    return el ? el.value : '';
  }

  // Elements
  const sendOtpBtn = document.getElementById('sendOtpBtn');
  const sendOtpBtnDisabled = document.getElementById('sendOtpBtnDisabled');
  const pr_email = document.getElementById('pr_email');
  const otpSection = document.getElementById('otpSection');
  const otpInputs = [...document.querySelectorAll('.otp-input')];
  const verifyOtpBtn = document.getElementById('verifyOtpBtn');
  const resendOtpBtn = document.getElementById('resendOtpBtn');
  const resendTimer = document.getElementById('resendTimer');
  const passwordSection = document.getElementById('passwordSection');
  const submitReset = document.getElementById('submitReset');
  const new_password = document.getElementById('new_password');
  const confirm_password = document.getElementById('confirm_password');
  const cancelReset = document.getElementById('cancelReset');

  // state
  let serverToken = null;
  let resendCountdown = 0;
  let resendInterval = null;

  function startResendCountdown(seconds){
    resendCountdown = seconds;
    resendOtpBtn.disabled = true;
    updateResendUI();
    if(resendInterval) clearInterval(resendInterval);
    resendInterval = setInterval(() => {
      resendCountdown--;
      if(resendCountdown <= 0){
        clearInterval(resendInterval);
        resendOtpBtn.disabled = false;
        resendTimer.textContent = '';
        resendOtpBtn.innerText = 'Resend OTP';
      } else {
        updateResendUI();
      }
    }, 1000);
  }

  function updateResendUI(){
    const mm = Math.floor(resendCountdown/60);
    const ss = String(resendCountdown % 60).padStart(2, '0');
    resendTimer.textContent = `${mm}:${ss}`;
    resendOtpBtn.innerText = `Resend (${mm}:${ss})`;
  }

  // OTP auto-advance
  otpInputs.forEach((input, idx) => {
    input.addEventListener('input', (e) => {
      const v = input.value.replace(/[^0-9]/g,'').slice(0,1);
      input.value = v;
      if(v && idx < otpInputs.length -1) otpInputs[idx+1].focus();
    });
    input.addEventListener('keydown', (e) => {
      if(e.key === 'Backspace' && !input.value && idx > 0){
        otpInputs[idx-1].focus();
      }
    });
  });

  // Send OTP
  sendOtpBtn?.addEventListener('click', function(){
    const email = pr_email.value.trim().toLowerCase();
    if(!email){ showToast('Enter email first'); pr_email.focus(); return; }
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ showToast('Enter a valid email'); pr_email.focus(); return; }

    sendOtpBtn.style.display='none';
    sendOtpBtnDisabled.style.display='inline-block';

    const fd = new FormData();
    fd.append('action','send_otp');
    fd.append('email', email);
    fd.append('csrfmiddlewaretoken', getCSRF());

    fetch("{% url 'password_reset' %}", {
      method: 'POST',
      headers: {'X-Requested-With':'XMLHttpRequest'},
      body: fd
    }).then(r => r.json()).then(json => {
      sendOtpBtn.style.display='inline-block';
      sendOtpBtnDisabled.style.display='none';
      if(json.success){
        showToast('OTP sent to your email', 'success');
        otpSection.style.display = 'block';
        otpInputs.forEach(i=>i.value='');
        otpInputs[0].focus();
        serverToken = json.token;
        startResendCountdown(90);
      } else {
        showToast(json.error || 'Failed to send OTP', 'danger');
      }
    }).catch(err=>{
      sendOtpBtn.style.display='inline-block';
      sendOtpBtnDisabled.style.display='none';
      console.error(err);
      showToast('Network error sending OTP', 'danger');
    });
  });

  // Resend
  resendOtpBtn?.addEventListener('click', function(){
    const email = pr_email.value.trim().toLowerCase();
    if(!email){ showToast('Enter email first'); return; }

    const fd = new FormData();
    fd.append('action','send_otp');
    fd.append('email', email);
    fd.append('csrfmiddlewaretoken', getCSRF());

    fetch("{% url 'password_reset' %}", {
      method: 'POST',
      headers: {'X-Requested-With':'XMLHttpRequest'},
      body: fd
    }).then(r => r.json()).then(json => {
      if(json.success){
        showToast('OTP resent to your email', 'success');
        serverToken = json.token;
        startResendCountdown(90);
        otpInputs.forEach(i=>i.value='');
        otpInputs[0].focus();
      } else {
        showToast(json.error || 'Could not resend OTP', 'danger');
      }
    }).catch(err => { console.error(err); showToast('Network error', 'danger'); });
  });

  // Verify OTP
  verifyOtpBtn?.addEventListener('click', function(){
    const code = otpInputs.map(i=>i.value.trim()).join('');
    if(code.length !== 6){ showToast('Enter the 6-digit code', 'danger'); return; }
    if(!serverToken){ showToast('Send OTP first.', 'danger'); return; }

    const fd = new FormData();
    fd.append('action','verify_otp');
    fd.append('token', serverToken);
    fd.append('code', code);
    fd.append('csrfmiddlewaretoken', getCSRF());

    fetch("{% url 'password_reset' %}", {
      method: 'POST',
      headers: {'X-Requested-With':'XMLHttpRequest'},
      body: fd
    }).then(r => r.json()).then(json => {
      if(json.success){
        showToast('OTP verified. Set a new password.', 'success');
        passwordSection.style.display = 'block';
        verifyOtpBtn.disabled = true;
        resendOtpBtn.disabled = true;
      } else {
        showToast(json.error || 'OTP verification failed', 'danger');
      }
    }).catch(err=>{ console.error(err); showToast('Network error verifying OTP', 'danger'); });
  });

  // Submit new password
  submitReset?.addEventListener('click', function(){
    const pwd = new_password.value.trim();
    const cpwd = confirm_password.value.trim();
    if(pwd.length < 8){ showToast('Password must be at least 8 characters', 'danger'); new_password.focus(); return; }
    if(pwd !== cpwd){ showToast('Passwords do not match', 'danger'); confirm_password.focus(); return; }
    if(!serverToken){ showToast('Missing token. Request OTP again.', 'danger'); return; }
    const code = otpInputs.map(i=>i.value.trim()).join('');
    if(code.length !== 6){ showToast('Enter the 6-digit OTP again', 'danger'); return; }

    const fd = new FormData();
    fd.append('action','reset_password');
    fd.append('token', serverToken);
    fd.append('code', code);
    fd.append('new_password', pwd);
    fd.append('confirm_password', cpwd);
    fd.append('csrfmiddlewaretoken', getCSRF());

    fetch("{% url 'password_reset' %}", {
      method: 'POST',
      headers: {'X-Requested-With':'XMLHttpRequest'},
      body: fd
    }).then(r => r.json()).then(json=>{
      if(json.success){
        showToast('Password reset successful. Redirecting to login...', 'success');
        setTimeout(()=> window.location.href = "{% url 'login' %}", 1400);
      } else {
        showToast(json.error || 'Could not reset password', 'danger');
      }
    }).catch(err => { console.error(err); showToast('Network/server error', 'danger'); });
  });

  // Cancel / reset UI
  cancelReset?.addEventListener('click', function(e){
    e.preventDefault();
    otpSection.style.display = 'none';
    passwordSection.style.display = 'none';
    serverToken = null;
    otpInputs.forEach(i=>i.value='');
    new_password.value = '';
    confirm_password.value = '';
  });
  </script>
</body>
</html>
