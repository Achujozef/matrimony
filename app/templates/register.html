<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kerala Vishwakarma — Matrimonial Registration</title>

<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  :root{
    --brand-500: #0b5ed7;
    --muted: #6c757d;
    --card: #ffffff;
    --radius: 12px;
  }

  /* Full-screen center wrapper */
  html, body {
    height: 100%;
    margin: 0;
  }
  body{
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:
      radial-gradient(circle at 10% 20%, rgba(11,94,215,0.04), transparent 6%),
      linear-gradient(180deg, #f7fbff, #f0f5fb 60%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
  }

  /* Constrain overall card and center it */
  .center-shell{
    width:100%;
    max-width:1100px;
    display:flex;
    align-items:stretch;
    gap:1.25rem;
    padding: 1rem;
  }

  .register-wrap{
    width:100%;
    display: grid;
    grid-template-columns: 1fr 460px;
    gap: 1.25rem;
    align-items: start;
    margin: 0 auto;
  }

  .brand-card{
    background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.95));
    border-radius: var(--radius);
    padding: 2rem;
    box-shadow: 0 12px 30px rgba(9,30,66,0.06);
    min-height: 520px;
  }

  .brand-badge{
    display:inline-grid;
    place-items:center;
    width:62px;height:62px;border-radius:14px;
    color:#fff;font-weight:700;
    background: linear-gradient(135deg,var(--brand-500),#084298);
    font-size:20px;
  }

  .form-card{
    background: var(--card);
    border-radius: var(--radius);
    padding: 1.5rem;
    box-shadow: 0 10px 25px rgba(2,6,23,0.06);
  }

  .step-indicators{display:flex;gap:.5rem;justify-content:center;margin-bottom:1rem}
  .step-indicators .dot{width:36px;height:36px;border-radius:9px;display:grid;place-items:center;font-weight:700}
  .dot.active{background:var(--brand-500);color:white}
  .dot.inactive{background:#eef3fb;color:var(--brand-500)}

  .section-desc { font-size:.95rem; color: #495057; text-align:center; margin-bottom:1rem; }

  .form-control, .form-select, textarea.form-control{border-radius:10px;padding:.75rem .85rem}
  textarea.form-control{min-height:100px}

  .btn-primary { border-radius:10px; font-weight:600; padding:.6rem 1rem; }
  .btn-ghost { background:transparent;border:1px solid #e7eefc;color:var(--brand-500); border-radius:10px }

  .toast-wrapper{position:fixed;top:1rem;right:1rem;z-index:1200}

  .step { display: none; }          /* hide all steps by default */
  .step.active { display: block; }  /* show only active step */

  /* mobile-friendly stacking */
  @media (max-width: 980px){
    .register-wrap{grid-template-columns:1fr; padding:0 0.5rem;}
    .brand-card{order:2}
    .form-card{order:1}
    .center-shell { padding: 0.5rem; }
  }

  /* small visual polish for centering on very short screens */
  @media (max-height: 600px){
    .brand-card { min-height: auto; padding: 1rem; }
    .form-card { padding: 1rem; }
  }
</style>
</head>
<body>

  <!-- Outer shell centers the content on screen -->
  <div class="center-shell">
    <div class="register-wrap">

      <!-- LEFT: Brand / Marketing -->
      <div class="brand-card">
        <div class="d-flex align-items-center gap-3">
          <div class="brand-badge">KV</div>
          <div>
            <div style="font-size:1.4rem;font-weight:700">Kerala Vishwakarma</div>
            <div style="color:var(--muted)">Community matrimonial — verified within shakhas.</div>
          </div>
        </div>

        <h3 style="margin-top:1.25rem; margin-bottom:.25rem">Find trusted matches inside your community</h3>
        <p style="color:#495057; margin-bottom:1rem;">
          Profiles are verified by Shakha presidents before they become public. You control photos and contact visibility.
        </p>

        <div class="mt-3">
          <div style="display:flex;gap:.75rem;align-items:flex-start;padding:.55rem 0">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#0b5ed7" viewBox="0 0 16 16"><path d="M6 10.793 3.354 8.146 2.646 8.854 6 12.207l8-8-0.707-0.707L6 10.793z"/></svg>
            <div><strong>Shakha-verified:</strong> New registrations require shakha president approval.</div>
          </div>

          <div style="display:flex;gap:.75rem;align-items:flex-start;padding:.55rem 0">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#0b5ed7" viewBox="0 0 16 16"><path d="M10.854 6.146a.5.5 0 0 0-.708 0L8 8.293 6.854 7.146a.5.5 0 1 0-.708.708L7.293 9l-1.147 1.146a.5.5 0 0 0 .708.708L8 9.707l1.146 1.147a.5.5 0 0 0 .708-.708L8.707 9l1.147-1.146a.5.5 0 0 0 0-.708z"/></svg>
            <div><strong>Privacy control:</strong> Hide photos and phone until connection; upgrade to premium to reveal contacts.</div>
          </div>

          <div style="display:flex;gap:.75rem;align-items:flex-start;padding:.55rem 0">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#0b5ed7" viewBox="0 0 16 16"><path d="M4 4h8v1H4zM4 7h8v1H4zM4 10h5v1H4z"/></svg>
            <div><strong>Manual payments:</strong> Upload payment screenshot for premium; admins verify and activate subscriptions.</div>
          </div>
        </div>

        <p style="color:var(--muted); margin-top:1rem">Need help? Contact your shakha president or <a href="mailto:support@example.com">support</a>.</p>
      </div>

      <!-- RIGHT: Form -->
      <div class="form-card">
        <div class="text-center mb-3">
          <div class="step-indicators">
            <div class="dot active" data-step="1">1</div>
            <div class="dot inactive" data-step="2">2</div>
            <div class="dot inactive" data-step="3">3</div>
          </div>
          <h4 style="margin:0 0 .4rem 0">Create your matrimonial profile</h4>
          <div id="stepDesc" class="section-desc">Account details — your community email and password (used to create username).</div>
        </div>

        <!-- Toast wrapper -->
        <div class="toast-wrapper" aria-live="polite" aria-atomic="true">
          <div id="serverToasts"></div>
        </div>

        <!-- FORM (AJAX submit) -->
        <form id="registrationForm" novalidate>
          {% csrf_token %}

          <!-- STEP 1: Account -->
          <div class="step active" id="step-1" data-desc="Account details — email & password. We will generate a username from the part before @.">
            <div class="mb-3">
              <label class="form-label required">Email</label>
              <input type="email" class="form-control" name="email" placeholder="you@domain.com" required>
              <div class="small" style="color:var(--muted)">Use your community email (this becomes username part).</div>
            </div>

            <div class="row g-2">
              <div class="col-md-6 mb-3">
                <label class="form-label required">Password</label>
                <div class="input-group">
                  <input type="password" class="form-control" name="password" placeholder="Create password" required minlength="8" id="pwd">
                  <button class="btn btn-outline-secondary" type="button" id="togglePwd" aria-label="Toggle password">Show</button>
                </div>
                <div class="small" style="color:var(--muted)">Minimum 8 characters.</div>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label required">Confirm Password</label>
                <input type="password" class="form-control" name="confirm_password" placeholder="Confirm password" required minlength="8">
              </div>
            </div>

            <div class="d-flex justify-content-end">
              <button type="button" class="btn btn-primary btn-step" onclick="nextStep(1)">Next</button>
            </div>
          </div>

          <!-- STEP 2: Profile -->
          <div class="step" id="step-2" data-desc="Profile details — phone, shakha and address. Shakha is required so your president can verify.">
            <div class="mb-3">
              <label class="form-label">Phone</label>
              <input type="text" class="form-control" name="phone" placeholder="10-digit phone (optional)">
            </div>

            <div class="mb-3">
              <label class="form-label required">Shakha</label>
              <select class="form-select" name="shakha" required>
                <option value="">Select your shakha</option>
                {% for shakha in shakhas %}
                  <option value="{{ shakha.id }}">{{ shakha.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Address</label>
              <textarea class="form-control" name="address" placeholder="City - Locality (optional)"></textarea>
            </div>

            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-ghost" onclick="prevStep(2)">Previous</button>
              <button type="button" class="btn btn-primary btn-step" onclick="nextStep(2)">Next</button>
            </div>
          </div>

          <!-- STEP 3: Matrimonial -->
          <div class="step" id="step-3" data-desc="Matrimonial profile — name, DOB, gender and optional details. This info is shown after shakha approval.">
            <div class="mb-3">
              <label class="form-label required">Full Name</label>
              <input type="text" class="form-control" name="full_name" placeholder="As you want displayed" required>
            </div>

            <div class="row g-2">
              <div class="col-md-6 mb-3">
                <label class="form-label required">Date of Birth</label>
                <input type="date" class="form-control" name="dob" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label required">Gender</label>
                <select class="form-select" name="gender" required>
                  <option value="">Select</option>
                  <option value="M">Male</option>
                  <option value="F">Female</option>
                  <option value="O">Other</option>
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Education</label>
              <input type="text" class="form-control" name="education" placeholder="e.g., B.Tech / M.Sc">
            </div>

            <div class="mb-3">
              <label class="form-label">Occupation</label>
              <input type="text" class="form-control" name="occupation" placeholder="e.g., Software Engineer">
            </div>

            <div class="mb-3">
              <label class="form-label">About</label>
              <textarea class="form-control" name="about" placeholder="A short note about yourself (optional)"></textarea>
            </div>

            <div class="row g-2">
              <div class="col-md-6 mb-3">
                <label class="form-label">Native Place</label>
                <input type="text" class="form-control" name="native_place" placeholder="Village / Town">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Marital Status</label>
                <select class="form-select" name="marital_status">
                  <option value="Never Married">Never Married</option>
                  <option value="Divorced">Divorced</option>
                  <option value="Widowed">Widowed</option>
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Family Details</label>
              <textarea class="form-control" name="family_details" placeholder="Short family background (optional)"></textarea>
            </div>

            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-ghost" onclick="prevStep(3)">Previous</button>
              <button type="submit" class="btn btn-success btn-step">Submit</button>
            </div>
          </div>
        </form>

        <div style="text-align:center;margin-top:12px;color:var(--muted)">Already have an account? <a href="{% url 'login' %}">Login here</a></div>
      </div>

    </div>
  </div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ---------- Helper: stepper and UI ---------- */
let currentStep = 1;
const maxStep = 3;
const stepDescEl = document.getElementById('stepDesc');

function showStep(n){
  if(n < 1) n = 1;
  if(n > maxStep) n = maxStep;
  currentStep = n;

  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  const active = document.getElementById('step-' + n);
  if(active) active.classList.add('active');

  document.querySelectorAll('.step-indicators .dot').forEach((d, i) => {
    d.classList.remove('active'); d.classList.add('inactive');
    if(i+1 === n){ d.classList.add('active'); d.classList.remove('inactive'); }
  });

  if(active && active.dataset && active.dataset.desc){
    stepDescEl.textContent = active.dataset.desc;
  } else {
    stepDescEl.textContent = '';
  }

  const firstReq = active.querySelector('[required]');
  if(firstReq) firstReq.focus();
}

function validateStep(n){
  const container = document.getElementById('step-' + n);
  if(!container) return false;
  const requireds = container.querySelectorAll('[required]');
  for(const el of requireds){
    const v = (el.value || '').toString().trim();
    if(!v){
      el.focus();
      showToast('Please fill all required fields in this section.', 'danger');
      return false;
    }
    if(el.name === 'email' && !/^[^ ]+@[^ ]+\.[a-z]{2,}$/i.test(v)){
      el.focus(); showToast('Enter a valid email address.', 'danger'); return false;
    }
    if(el.name === 'password' && v.length < 8){
      el.focus(); showToast('Password must be at least 8 characters.', 'danger'); return false;
    }
  }

  if(n === 1){
    const p = document.querySelector('#step-1 input[name="password"]').value;
    const c = document.querySelector('#step-1 input[name="confirm_password"]').value;
    if(p !== c){ showToast('Passwords do not match', 'danger'); return false; }
  }

  if(n === 2){
    const phone = document.querySelector('#step-2 input[name="phone"]').value.trim();
    if(phone && !/^[0-9]{10}$/.test(phone)){ showToast('Enter a valid 10-digit phone number', 'danger'); return false; }
  }

  return true;
}

function nextStep(n){
  if(validateStep(n)){
    const next = n + 1;
    showStep(next);
  }
}
function prevStep(n){
  const prev = n - 1;
  showStep(prev);
}

showStep(currentStep);

/* Toggle Password */
const toggleBtn = document.getElementById('togglePwd');
if(toggleBtn){
  toggleBtn.addEventListener('click', function(){
    const p = document.getElementById('pwd');
    if(!p) return;
    if(p.type === 'password'){ p.type = 'text'; this.innerText = 'Hide'; }
    else { p.type = 'password'; this.innerText = 'Show'; }
  });
}

/* Toast helper */
const toastContainer = document.getElementById('serverToasts');
function showToast(message, type='danger', ttl=3000){
  if(!toastContainer) {
    alert(message); return;
  }
  const tpl = document.createElement('div');
  tpl.className = `toast align-items-center text-bg-${type} border-0 mb-2`;
  tpl.setAttribute('role','alert'); tpl.setAttribute('aria-live','assertive'); tpl.setAttribute('aria-atomic','true');
  tpl.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
  toastContainer.appendChild(tpl);
  const b = new bootstrap.Toast(tpl, { delay: ttl });
  b.show();
  tpl.addEventListener('hidden.bs.toast', () => tpl.remove());
}

/* AJAX submit to backend */
const form = document.getElementById('registrationForm');
if(form){
  form.addEventListener('submit', function(e){
    e.preventDefault();
    if(!validateStep(3)){ return; }

    const data = new FormData(form);
    fetch("{% url 'register' %}", {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      body: data
    })
    .then(r => r.json())
    .then(json => {
      if(json.success){
        showToast(json.message || 'Registered successfully', 'success', 2500);
        setTimeout(()=> { window.location.href = "{% url 'login' %}"; }, 1400);
      } else {
        showToast(json.error || 'Registration failed', 'danger', 3500);
      }
    })
    .catch(err => {
      console.error(err);
      showToast('Network/server error. Try again.', 'danger', 3500);
    });
  });
}
</script>

</body>
</html>
